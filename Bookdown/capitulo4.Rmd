```{r, echo=F, warning=FALSE, results='asis', message = FALSE}

library(knitr)
library(pander)
library(forecast)

# Preparando o banco de incidencia de dengue
dengue_original=read.csv("~/Documentos/cursos_ecologicos_2019/dados/denguecases.csv")
denguecases=aggregate(Dengue_Cases~Month+Year,dengue_original,sum)
denguecasests=ts(denguecases$Dengue_Cases,start=c(2008,1),end=c(2016,12),frequency=12)

# Set so that long lines in R will be wrapped:
opts_chunk$set(tidy.opts=list(width.cutoff=50),tidy=TRUE)

```


# Modelagem em Séries Temporais

## ARIMA 

Em estatística e econometria, particularmente em análise de séries temporais, um modelo auto-regressivo integrado de médias móveis (autoregressive integrated moving average ou **ARIMA**, na sigla em inglês) é uma generalização de um modelo auto-regressivo de médias móveis (**ARMA**). Ambos os modelos são ajustados aos dados da série temporal para entender melhor os dados ou para prever pontos futuros na série. Modelos ARIMA são aplicados em alguns casos em que os dados mostram evidências de não estacionariedade, em que um passo inicial de diferenciação (correspondente à parte "integrada" do modelo) pode ser aplicado uma ou mais vezes para eliminar a não estacionariedade.

- Colocar pressuposto de normalidade

Temos então:

- **AR – Autoregressivo**: avalia a relação entre os períodos (lags): autocorrelação, ou seja, indica que a variável evoluinte de interesse é regressada em seus próprios valores defasados, isto é, anteriores. Extrai essa influência;

- **I – Integrated**: Aplica a diferenciação, se necessária, ou seja, indica que os valores de dados foram substituídos com a diferença entre seus valores e os valores anteriores e este processo diferenciador pode ter sido realizado mais de uma vez

- **MA – Moving Average**: Indica que o erro de regressão é na verdade uma combinação linear dos termos de erro, cujos valores ocorreram contemporaneamente e em vários momentos no passado, ou seja, avalia erros entre períodos e extrai estes erros (não tem relação com MA usados para suavização da ST). 

![](~/Documentos/cursos_ecologicos_2019/figuras/ARIMA.png){width=700px}


- **p** é a ordem (número de defasagens) do modelo auto-regressivo;

- **d** é o grau de diferenciação (o número de vezes em que os dados tiveram valores passados subtraídos);

- **q** é a ordem do modelo de média móvel.

Exemplos:

| Parâmetro | Descrição                                                                                         |
|-----------|---------------------------------------------------------------------------------------------------|
| $p = 1$   | Significa que uma determinada observação pode ser explicada pela observação prévia + erro         |
| $p = 2$   | Significa que uma determinada observação pode ser explicada por duas observações prévias + erro   |
| $d = 0$   | Significa que não é aplica diferenciação                                                          |
| $d = 1$   | Significa que será aplicada diferenciação de primeira ordem                                       |
| $d = 2$   | Significa que será aplicada diferenciação de segunda ordem                                        |
| $q = 1$   | Significa que uma determinada observação pode ser explicada pelo erro da observação prévia        |
| $q = 2$   | Significa que uma determinada observação pode ser explicada pelo erro de duas observações prévias |



|         ARIMA         |                     Descrição                     |
|:---------------------:|:-------------------------------------------------:|
| AR(1) ou ARIMA(1,0,0) | Apenas elemento autoregressivo , de $1^{a}$ ordem |
| AR(2) ou ARIMA(2,0,0) | Apenas elemento autoregressivo , de $2^{a}$ ordem |
| MA(1) ou ARIMA(0,0,1) | Apenas Média Móvel                                |
| ARMA(1,1)             | Autorregressão e média móvel de $1^{a}$ ordem     |


### Modelo Autoregressivo de ordem *p*

- Notação: AR(p) ou ARIMA(p,0,0)

| Processo |                            Modelo                            |
| :------: | :----------------------------------------------------------: |
|  AR(1)   |                $$z_t = \phi_1 z_{t-1} + a_t$$                |
|  AR(2)   |       $$z_t = \phi_1 z_{t-1} + \phi_2 z_{t-2} + a_t$$        |
| $\dots$  |                           $\dots$                            |
|  AR(p)   | $$z_t = \phi_1 z_{t-1} + \phi_2 z_{t-2} + ... + \phi_p z_{t-p} + a_t$$ |


- No caso AR(1) basta que $|\phi_1| < 1$ para que o processo seja estacionário.

### Modelo de Médias Móveis de ordem *q*

- Notação: MA(q) ou ARIMA(0,0,q)

O modelo pode ser escrito baseado nas defasagens  (informações passadas) do ruído branco

| Processo |                            Modelo                            |
| :------: | :----------------------------------------------------------: |
|  MA(1)   |                $$z_t = a_t - \theta_1 a_{t-1}$$                |
|  MA(2)   |       $$z_t = a_t - \theta_1 a_{t-1} - \theta_2 a_{t-2}$$        |
| $\dots$  |                           $\dots$                            |
|  MA(q)   | $$z_t = a_t - \theta_1 a_{t-1} - \theta_2 a_{t-2} - ... - \theta_p a_{t-q}$$ |


### Modelo Autorregressivo de Médias Móveis de ordem *p* e *q*

- Notação: ARMA(p,q) ou ARIMA(p,0,q)


| Processo |                            Modelo                            |
| :------: | :----------------------------------------------------------: |
|  MA(1)   |                $$z_t = \phi_1 z_{t-1} + a_t - \theta_1 a_{t-1}$$                |
|  MA(2)   |       $$z_t = \phi_1 z_{t-1} + \phi_2 z_{t-2} + a_t - \theta_1 a_{t-1} - \theta_2 a_{t-2}$$        |
| $\dots$  |                           $\dots$                            |
|  MA(q)   | $$z_t = \phi_1 z_{t-1} + \phi_2 z_{t-2} + ... + \phi_p z_{t-p} + a_t - \theta_1 a_{t-1} - \theta_2 a_{t-2} - ... - \theta_p a_{t-q}$$ |

- No caso ARMA(1,1), o processo será estacionário se $|\phi_1| < 1$ e $|\theta_1| < 1$, respectivamente.

### **Modelos ARIMA não sazonais** 

São geralmente denotados como $ARIMA(p,d,q)$, em que os parâmetros **p,d,q** são números inteiros não negativos.

- Robusto: Pode ser usado em praticamente qualquer tipo de ST

- Dados estáveis, com poucos outliers

- Requer dados estacionários: pode ser transformada usando diferenciação: remove tendências

- Subtrai a observação do período atual do período anterior

- A diferenciação pode ser feita 1x: diferenciação de primeira ordem

- Ou pode ser necessário uma segunda vez: diferenciação de segunda ordem (mais raro)



### **Modelos ARIMA sazonais (SARIMA)** 

São geralmente denotados como $ARIMA(p,d,q)(P,D,Q)_{m}$, em que:

- **m** se refere ao número de períodos em cada temporada;

- **P, D e Q** se referem aos termos de auto-regressão, diferenciação e média móvel para a parte sazonal do modelo ARIMA.

## Função de Autocorrelação Parcial (FACP) - (*Partial Autocorrelation Function - PACF*)

Uma outra ferramenta utilizada no processo de identificação do modelo é a **Função de Autocorrelação Parcial(FACP)**.  Esta medida corresponde a correlação de $Z_t $ e $ Z_{t-k} $ removendo o efeito das observações $Z_{t-1}, Z_{t-2}, \dots , Z_{t-k+1}$  e é denotada por $\rho_{k}$, ou seja

$$\rho_{kk} = Corr(X_t, X_{t-l}|X_{t-1}, X_{t-2},\dots,X_{t-k+1})$$	


### Roteiro para o ajuste do modelo

- Para a construção do modelo podemos seguir o seguinte roteiro no qual a escolha da estrutura do modelo é baseado nos próprios dados:

1) Identifica-se um modelo com base na análise de autocorrelações, autocorrelações parciais e outros critérios;

2) Estima-se os parâmetros do modelo identificado;

3) Verificar se o modelo ajustado é adequado aos dados através de uma análise de resíduos.

4) Caso o modelo não seja adequado o roteiro é repetido, voltando à fase de identificação do modelo.


- Como definir valores de p,d e q ?

 - **p**: ordem da parte autoregressiva - PACF

 - **d**: grau de diferenciação – Teste de Estacionariedade

 - **q**: ordem da média móvel - ACF


- Esse processo pode ser extremamente difícil, mesmo para experientes. E Nem sempre o modelo mais sugestivo é o melhor.

- Existem vários critérios para identificação de um modelo, por isso, é possível identificar modelos diferentes dependendo do critério que foi escolhido para identificação.


- Como saber qual o melhor modelo ?

  - Akaike Information Criteria (AIC e AICc)
  
 *AIC = - 2ln(verossimilhança) + 2(k)*
 
 *AICc = AIC + \dfrac{2k^2 + 2k}{n-k-1}*
 
Sabendo que, $n$ é o número de observações e $k$ número de parâmetros estimados pelo modelo.

  - Bayesian Information Criteria (BIC)
  
   *BIC = - 2ln(verossimilhança) + ln(n)k*


  - Outros

  - Ou testar todas as combinações prováveis, mas isso pode ser um pouco demorado se for feito de forma manual.

  - Sugestão: Usar a função ***auto.arima()***

---

### Auto.arima()

- Testa diferentes combinações de p,d e r

- Extremamente flexível

- Mesmo intuindo um modelo, você pode usa-la para confirmar sua parametrização


Alguns parâmetros importantes da função *auto.arima()*

- stationary - If TRUE, restricts search to stationary models.

- seasonal - If FALSE, restricts search to non-seasonal models

- stepwise - If TRUE, will do stepwise selection (faster). Otherwise, it searches over all models. Non-stepwise selection can be very slow, especially for seasonal models.

- trace - If TRUE, the list of ARIMA models considered will be reported.

- approximation - If TRUE, estimation is via conditional sums of squares and the information criteria used for model selection are approximated. The final model is still computed using maximum likelihood estimation. Approximation should be used for long time series or a high seasonal period to avoid excessive computation times.

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, fig.align = "center"}

# Utilizando trace = T, será possível verificar todo o processo de criação e teste dos modelos
# modelo1 = auto.arima(denguecasests, trace = F)
# kable(summary(modelo1))

# Neste modelo, será feito uma busca maior para uma solução "mais ótima"
# modelo2 = auto.arima(denguecasests, trace = F, stepwise = F, approximation = F)
# kable(summary(modelo2))

```

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, fig.align = "center"}

# Estimando as previsões
# prev1 = forecast(modelo1, h=12)
# autoplot(prev1) + 
# geom_hline(yintercept=range(0), color='black', size=0.5)
# 
# 
# prev2 = forecast(modelo2, h=12)
# autoplot(prev2) + 
# geom_hline(yintercept=range(0), color='black', size=0.5)
# 
# 
# # Comparar os modelos
# plot(prev1, main='Comparação Modelo 1 vs Modelo 2')
# lines(prev2$mean, col="red", add=T)
# abline(h=0, color='gray', size=1)
# legend("topleft", legend=c("Adirtivo", "Multiplicativo"),
#        col=c("blue", "red"), lty=1:2, cex=0.8)

```


```{r, echo=F, warning=FALSE, results='asis', message = FALSE, fig.align = "center"}

#comparando textual
# meses   <- seq(from=as.Date("2017-01-01"), to=as.Date("2017-12-30"), by="month")
# Modelo_1 <- prev1$mean
# Modelo_2 <- prev2$mean
# tab <- data.frame(meses, Modelo_1, Modelo_2)
# kable(tab)

```

---

### Comparando o ACF de ambos os modelos

```{r, echo=T, warning=FALSE, results='asis', out.width = "100%", message = FALSE, fig.align = "center"}
# par(mfrow=c(1,3))
# acf(denguecasests, lag.max=20, main="Dados Original")
# acf(modelo1$residuals, lag.max=20, main="Modelo 1")
# acf(modelo2$residuals, lag.max=20, main="Modelo 2")

```

---

### Executando o teste Ljung-Box 

```{r, echo=T, warning=FALSE, results='asis', out.width = "100%", message = FALSE, fig.align = "center"}
# Dados Originais
# Box.test(denguecasests, lag=20, type="Ljung-Box")
# # Modelo 1
# Box.test(modelo1$residuals, lag=20, type="Ljung-Box")
# # Modelo 2
# Box.test(modelo2$residuals, lag=20, type="Ljung-Box")

```

---

### Distribuição dos Resíduos no tempo 

```{r, echo=T, warning=FALSE, results='asis', out.width = "100%", message = FALSE, fig.align = "center"}

# par(mfrow=c(1,2))
# plot.ts(modelo1$residuals, main="Modelo 1")
# abline(h=0, col="red", lty = 3)
# plot.ts(modelo2$residuals, main="Modelo 2")
# abline(h=0, col="red", lty = 3)

```

---

### Normalidade dos Resíduos 

```{r, echo=T, warning=FALSE, results='asis', out.width = "100%", message = FALSE, fig.align = "center"}

# par(mfrow=c(1,2))
# hist(modelo1$residuals, main="Modelo 1")
# abline(v=0, col="darkred", lty = 2)
# hist(modelo2$residuals, main="Modelo 2")
# abline(v=0, col="darkred", lty = 2)
# 
# # Teste de Shapiro-Wilk
# shapiro.test(modelo1$residuals)
# shapiro.test(modelo2$residuals)

```

## O problema !

**Como as variáveis se comportam relacionadas umas com as outras ?**

- Idade $\longleftrightarrow$ mortes por causas externas de 5 a 45 anos

- Renda $\longleftrightarrow$ doenças cardiovasculares

- Distância aos serviços de saúde $\longleftrightarrow$ mamografia

- Adesão ao tratamento do HIV $\longleftrightarrow$ desenvolvimento de resistência a vírus

$\cdots$

- Tempo  $\longleftrightarrow$ doenças transmissíveis

- Espaço  $\longleftrightarrow$ doenças transmitidas por vetores


## GAM (generalized Additive Models)


- Extensão do GLM, onde o preditor linear $\eta$ não é limitado para a regressão linear

- O modelo inclui qualquer função das covariáveis independentes ($x_i$)

$$\eta = \beta_0 + f_1(x_1) + f_2(x_2) + \ldots$$

- $f(x) \rightarrow$ pode ser uma função não paramétrica, como *loess*

- Quando usar ? Quando o efeito da covariável muda dependendo do seu valor


## Por que não usar ?

- Os modelos estatísticos visam explicar os dados observados, não simplesmente reproduzi-lo $\rightarrow$ **overfitting**

- Modelos paramétricos em geral são melhores para estimar erros padrão ou intervalos de confiança

- Modelos paramétricos são mais eficientes, se corretamente especificados (menor número de observações)


## GAM em Séries Temporais

- A idéia principal é modelar o efeito de covariáveis em alguns
eventos de saúde ao longo do tempo

- Razões:

    - Permitir a inclusão da dependência do tempo

    - Relação não-linear
    
    - Tendência e sazonalidade podem ser facilmente incorporadas

- Considerando a variável resposta uma contagem, as escolhas para as distribuições são:

    - Poisson: $\lambda$ $=$ valores esperados e $=$ variância $\rightarrow$ superdispersão
    
    - Quasipoisson: não é uma distribuição, mas uma maneira de relaxar suposição do modelo anterior e levar em consideração a superdispersão. (Não estima o AIC automaticamente).
    
    - Negative Binomial: tem uma média $\mu$, um parâmetro de escala $\theta$ e a variância como a função $V(\mu)=\mu+\mu^2/\theta$
  
    - Modelos com inflação zero: modelos de mistura que combinam uma massa pontual a zero com uma distribuição de contagem como Poisson, geométrica ou binomial negativa

### Exemplo de um modelo GAM

$$\text{Lepto}(t) = \text{rain}(t-?) + \text{humidity}(t-?) + AR(t,t-1) + trend + seasonality + \varepsilon$$

- Tendência e Sazonalidade $\to$ função suavizadora

- Covariáveis $\to$ lag no tempo

- É possível incluir a variabilidade populacional em risco (*offset*)


## Exercícios Propostos
  
1) Utilzando o baco de dados do R chamado Seatbelts, que é baseado em uma série histórica que mostra os totais mensais dos condutores de automóveis na Grã-Bretanha mortos ou gravemente feridos, de 1969 a dezembro de 1984. O uso obrigatório dos cintos de segurança foi introduzido em 31 de janeiro de 1983.


|   Variáveis   |                          Descrição                          |
|:-------------:|:-----------------------------------------------------------:|
| DriversKilled | Motoristas de carro mortos                                  |
| drivers       | Mesmo que UKDriverDeaths                                                       |
| front         | Passageiros do banco da frente mortos ou gravemente feridos |
| rear          | Passageiros do banco traseiro mortos ou gravemente feridos  |
| kms           | Distância percorrida                                        |
| PetroPrice    | Preço da gasolina                                           |
| VanKilled     | Número de condutores de van (veículo leve de mercadorias)   |
| law           | A lei estava em vigor naquele mês (1/0)                     |

Pede-se:

1) Ajuste um modelo ARIMA com a variável de desfecho DriversKilled;
2) Ajuste um modelo GAM utilizando a variável de desfecho DriversKilled e verifique quais variáveis estão mais associadas ao modelo.




## Bibliografia sugerida

Asteriou, D.; Hall, S.G. Applied econometrics. Macmillan International Higher Education, 2015.

Harvey, A. C. and Durbin, J. The effects of seat belt legislation on British road casualties: A case study in structural time series modelling. Journal of the Royal Statistical Society series A, 149, 187–227. 1986.

Webster, C.E.J. Time series properties of econometric models and their implied ARIMA representation. 1983.

Brockwell, Peter J.; DAVIS, Richard A.; CALDER, Matthew V. Introduction to time series and forecasting. New York: springer, 2002.