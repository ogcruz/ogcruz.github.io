```{r, echo=F, warning=FALSE, results='asis', message = FALSE}

library(knitr)
library(pander)
library(forecast)

# Preparando o banco de incidencia de dengue
dengue_original=read.csv("~/Documentos/cursos_ecologicos_2019/dados/denguecases.csv")
denguecases=aggregate(Dengue_Cases~Month+Year,dengue_original,sum)
denguecasests=ts(denguecases$Dengue_Cases,start=c(2008,1),end=c(2016,12),frequency=12)

# Set so that long lines in R will be wrapped:
opts_chunk$set(tidy.opts=list(width.cutoff=50),tidy=TRUE)

```



# Modelagem em Séries Temporais

## Modelos


Podemos descrever o algorítimo através dos seguintes passos:

Considera-se uma classe geral de modelos para a análise;
identifica-se um modelo com base na análise de autocorrelações, autocorrelações parciais e outros critérios;
estima-se os parâmetros do modelo identificado;
verificar se o modelo ajustado é adequado aos dados através de uma análise de resíduos.
Caso o modelo não seja adequado o algoritmo é repetido, voltando à fase de identificação.
Existem vários critérios para identificação de um modelo, por isso, é possível identificar modelos diferentes dependendo do critério que foi escolhido para identificação.

## Análise dos Resíduos


```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "100%", fig.align = "center"}
setwd("~/Documentos/cursos_ecologicos_2019/dados")
dengue_original=read.csv("denguecases2.csv")
denguecasests=ts(dengue_original$Dengue_Cases,start=c(2008,1),end=c(2016,12),frequency=12)

prev = auto.arima(denguecasests)
head(prev$residuals)

#analisando os residuais
autoplot(prev$residuals)
hist(prev$residuals)
var(prev$residuals,na.rm = T)
mean(as.vector(prev$residuals),na.rm = T)

```


Segundo o teste de autocorrelação ***Ljung-Box***, temos:

$H_{0}$: Os resíduos são i.i.d.

$H_{1}$: Os resíduos não são i.i.d.


Segundo o teste de normalidade ***Shapiro-Wilk***, temos:

$H_{0}$: Os resíduos apresentam normalidade na distribuição

$H_{1}$: Os resíduos não apresentam normalidade na distribuição

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "100%", fig.align = "center"}

#acf 
acf(prev$residuals, na.action = na.pass)
#funcao especial para checar residuais
checkresiduals(prev)
#teste de normalidade
shapiro.test(prev$residuals)

```

- Como o *p-valor = 0.1656* para o tete de Ljung-Box, podemos dizer que não existe evidências de que exista autocorrelação entre as incidências de dengue no período de estudo. 

- Também podemos verificar que o pressuposto de noralidade não pode sr aceito, pois *p-valor = 0.01275 do teste de shapiro-wilk.




## Predição


Predizer o futuro possibilita:

- Fazer planos a longo, médio e curto prazo;

- Tomar decisões apropriadas.


Futuro envolve incerteza $\Leftrightarrow$ previsões não são perfeitas.

Objetivo é reduzir ao máximo os erros de previsão.

---

## Por que dos erros ?

```{r, echo=F, fig.show = "hold", out.width = "100%", fig.align = "center"}
knitr::include_graphics("~/Documentos/cursos_ecologicos_2019/figuras/granada1.png")
```

---


```{r, echo=F, fig.show = "hold", out.width = "100%", fig.align = "center"}
knitr::include_graphics("~/Documentos/cursos_ecologicos_2019/figuras/copa.png")
```

---

- Conceitualmente, toda previsão está errada

- O objetivo é minimizar o erro (torna-lo menor possível)

---

## Regressão Linear vs Séries Temporais

```{r, echo=F, fig.show = "hold", out.width = "100%", fig.align = "center"}
knitr::include_graphics("~/Documentos/cursos_ecologicos_2019/figuras/regressaost.png")
```

---

## Como prever usando séries temporais ?

- Usando os próprios dados – **Séries temporais puras**

- Usando outras variáveis – **Modelo explanatório**

- Usando as duas técnicas – **Modelo misto**

---

### Modelagem, aprendizado e previsão

- A parte central da análise de ST, é a construção de um modelo. Tal modelo pode ser do âmbito matemático, estatístico e/ou computacional.

- **Modelo** - esquema de descrição (explicação) que organiza a informação (experiência) de forma a propiciar aprendizagem (informação) e previsão.

- Bom modelo permite aprendizado levando a previsões adequadas.

    • Devido à incerteza presente, modelo é probabilístico;
    
    • Deve também ser parcimonioso;
    
    • Deve ser relativamente simples e flexível para poder se adaptar ao futuro (incerto) e facilitar aprendizado;

    • **Aprendizado** é o processamento de informaçãoo através do modelo;
    
    • **Previsão** é a hipótese, conjectiva ou especulação sobre o futuro.
 
---

Esquema de um sistema de previsão:

```{r, echo=F, fig.show = "hold", out.width = "100%", fig.align = "center"}
knitr::include_graphics("~/Documentos/cursos_ecologicos_2019/figuras/esquemaST.png")
```

[Análise de Séries Temporais - Prof. Hélio Migon (IM/DME/UFRJ)](http://www.dme.ufrj.br/dani/pdf/slidespartefrequentista.pdf)

---

## Considerações sobre previsões


```{r, echo=F, fig.show = "hold", out.width = "100%", fig.align = "center"}
knitr::include_graphics("~/Documentos/cursos_ecologicos_2019/figuras/previsso.png")
```

---

```{r, echo=F, fig.show = "hold", out.width = "100%", fig.align = "center"}
knitr::include_graphics("~/Documentos/cursos_ecologicos_2019/figuras/previsso2.png")
```

---

Para ajustar um bom modelos devemos:

- Avaliar os resíduos;

- Avaliar a performance do modelos  (MAE,RMSE etc.);

- Avaliar as  métricas (AIC, BIC etc.).

Dicas gerais:

- Uma boa análise dos resíduos em conformidade não indicam por si só um bom modelo;

- Um primeiro modelo bom, provavelmente pode ser melhorado;

- Inteligência inclui a capacidade de escolher as informações relevantes (seleção de variáveis).
 
---

## Algumas técnicas para previsão em ST

### **Técnicas Simples**

  - Naive
    
  - Mean
    
  - Drift
    

### **Técnicas Clássicas**

  - Suavização Exponencial (Holt-Winters)
  
  - ARIMA
  
  - Regressão
    
### **Técnicas Avançadas**

  - Modelos de equações simultâneas ou econométricos
    
  - Redes Neurais
    
  - Modelos de espaço de estados ou dinâmicos
    
---

## Naive 

- **Naive Simples:** Projeta o último valor para o futuro.

- **Naive Sazonal:** Para dados com sazonalidade presente, ele considera o último valor no mesmo período de tempo.


```{r, echo=F, fig.show = "hold", out.width = "100%", fig.align = "center"}
knitr::include_graphics("~/Documentos/cursos_ecologicos_2019/figuras/naive1.png")
```

```{r, echo=F, fig.show = "hold", out.width = "100%", fig.align = "center"}
knitr::include_graphics("~/Documentos/cursos_ecologicos_2019/figuras/naive2.png")
```

Aplicando a técnica de previsão nos casos de dengue:


```{r, echo=T, warning=FALSE, results='asis', message = FALSE, fig.align = "center"}
# Naive Simples
# Faz a previsao para cinco meses
prev = naive(denguecasests, h=5, level = c(80, 95))
autoplot(prev)
kable(prev)

```


```{r, echo=T, warning=FALSE, results='asis', message = FALSE, fig.align = "center"}
# Naive Sazonal
# Faz a previsao para cinco meses
# Default level = c(80, 95)
prev = snaive(denguecasests, h=5, level = c(80, 95)) 
autoplot(prev)
kable(prev)

# Comparando os valores preditos com os valores observados
kable(window(denguecasests, start=c(2016,1), end=c(2016,5)))

```

---

## Mean

- Calcula a média e usa como previsão para o futuro.


```{r, echo=F, fig.show = "hold", out.width = "100%", fig.align = "center"}
knitr::include_graphics("~/Documentos/cursos_ecologicos_2019/figuras/meanf.png")
```

Aplicando a técnica de previsão nos casos de dengue:


```{r, echo=T, warning=FALSE, results='asis', message = FALSE, fig.align = "center"}
# Faz a previsao para cinco meses
prev = meanf(denguecasests, h=5)
autoplot(prev)
kable(prev)
#verifica a media
mean(fdeaths)

```

Previsão baseada apenas no último ano da ST.

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, fig.align = "center"}
# fazendo uma previsao com um subconjunto dos dados
denguecasests2 = window(denguecasests,start=c(2016,1),end=c(2016,12))
autoplot(denguecasests2)
mean(denguecasests2)
prev2 = meanf(denguecasests2, h=5)
autoplot(prev2)
kable(prev2)

# compara as duas previsoes
plot(prev)
lines(prev2$mean, col="red")

```

---

## Drift

- Faz uma previsão linear para o futuro acompanhando a tendência da série;

- Equivale a plotar uma reta entre o primeiro e último valor da série;

- Pode sr utilizado em ST com a tendência expressiva.


```{r, echo=F, fig.show = "hold", out.width = "70%", fig.align = "center"}
knitr::include_graphics("~/Documentos/cursos_ecologicos_2019/figuras/drift1.png")
```

```{r, echo=F, fig.show = "hold", out.width = "100%", fig.align = "center"}
knitr::include_graphics("~/Documentos/cursos_ecologicos_2019/figuras/drift2.png")
```

Aplicando a técnica de previsão nos casos de dengue:


```{r, echo=T, warning=FALSE, results='asis', message = FALSE, fig.align = "center"}
# Faz a previsao para 12 meses
par(mfrow=c(2,2))
# Exatamente igual ao Naive
prev1 = rwf(denguecasests, h=12, drift = F)
autoplot(prev1)

# Drift propriamente dito
prev2 = rwf(denguecasests, h=12, drift = T)
autoplot(prev2)

```

Para visualizar melhor o uso dessa função, vamos utilizar o dataset do próprio R chamado *austres* (Números (em milhares) de residentes australianos medidos trimestralmente de março de 1971 a março de 1994).


```{r, echo=T, warning=FALSE, results='asis', message = FALSE, fig.align = "center"}
# Faz a previsao para 12 meses
par(mfrow=c(2,2))
# Exatamente igual ao Naive
prev1 = rwf(austres, h=12, drift = F)
autoplot(prev1)

# Drift propriamente dito
prev2 = rwf(austres, h=12, drift = T)
autoplot(prev2)

```

## O problema !

**Como as variáveis se comportam relacionadas umas com as outras ?**

- Idade $\longleftrightarrow$ mortes por causas externas de 5 a 45 anos

- Renda $\longleftrightarrow$ doenças cardiovasculares

- Distância aos serviços de saúde $\longleftrightarrow$ mamografia

- Adesão ao tratamento do HIV $\longleftrightarrow$ desenvolvimento de resistência a vírus

$\cdots$

- Tempo  $\longleftrightarrow$ doenças transmissíveis

- Espaço  $\longleftrightarrow$ doenças transmitidas por vetores


## GAM (generalized Additive Models)


- Extensão do GLM, onde o preditor linear $\eta$ não é limitado para a regressão linear

- O modelo inclui qualquer função das covariáveis independentes ($x_i$)

$$\eta = \beta_0 + f_1(x_1) + f_2(x_2) + \ldots$$

- $f(x) \rightarrow$ pode ser uma função não paramétrica, como *loess*

- Quando usar ? Quando o efeito da covariável muda dependendo do seu valor


## Por que não usar ?

- Os modelos estatísticos visam explicar os dados observados, não simplesmente reproduzi-lo $\rightarrow$ **overfitting**

- Modelos paramétricos em geral são melhores para estimar erros padrão ou intervalos de confiança

- Modelos paramétricos são mais eficientes, se corretamente especificados (menor número de observações)


## GAM em Séries Temporais

- A idéia principal é modelar o efeito de covariáveis em alguns
eventos de saúde ao longo do tempo

- Razões:

    - Permitir a inclusão da dependência do tempo

    - Relação não-linear
    
    - Tendência e sazonalidade podem ser facilmente incorporadas

- Considerando a variável resposta uma contagem, as escolhas para as distribuições são:

    - Poisson: $\lambda$ $=$ valores esperados e $=$ variância $\rightarrow$ superdispersão
    
    - Quasipoisson: não é uma distribuição, mas uma maneira de relaxar suposição do modelo anterior e levar em consideração a superdispersão. (Não estima o AIC automaticamente).
    
    - Negative Binomial: tem uma média $\mu$, um parâmetro de escala $\theta$ e a variância como a função $V(\mu)=\mu+\mu^2/\theta$
  
    - Modelos com inflação zero: modelos de mistura que combinam uma massa pontual a zero com uma distribuição de contagem como Poisson, geométrica ou binomial negativa

### Exemplo de um modelo GAM

$$\text{Lepto}(t) = \text{rain}(t-?) + \text{humidity}(t-?) + AR(t,t-1) + trend + seasonality + \varepsilon$$

- Tendência e Sazonalidade $\to$ função suavizadora

- Covariáveis $\to$ lag no tempo

- É possível incluir a variabilidade populacional em risco (*offset*)