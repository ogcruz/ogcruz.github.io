
#  Análise Exploratória de uma Séries Temporal 


## Análise Exploratória

### A função *ts* é a mais utilizada no pacote R.

- ***data***: um vetor ou matriz com dados para a série

- ***start***: tempo da primeira observação

- ***end***: tempo da última observação

- ***frequency***: quantidade de observações por unidade de tempo, podendo representar: Anual = 1, Trimestral = 4, Mensal = 12 e Semanal = 52

---

### Criando uma Série Temporal

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "70%", fig.align = "center"}
library(forecast)
library(ggplot2)
library(urca)
library(lmtest)
library(seasonal)
library(seasonalview)

# Uma serie temporal normalmente distribuida
myts = rnorm(60)
myts = ts(myts,start = c(2012,1), end=c(2016,12), frequency=12)
plot(myts)

```

---

### Importando uma tabela em formato de Série Temporal

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "70%", fig.align = "center"}
# Para escolher o diretório
# tempts = read.csv(file.choose(), sep=",",header = F) 

tempts = read.csv("~/Documentos/cursos_ecologicos_2019/dados/importar.csv", sep=",",header = F) 
tempts = ts(tempts[2],start = 1884, end=1939, frequency=1)
class(tempts)
plot(tempts)

```

---

### Utilizando um banco de dados real em uma análise de Série Temporal

- Incidência de dengue nas Filipinas, 2008 - 2016

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "70%", fig.align = "center"}

setwd("~/Documentos/cursos_ecologicos_2019/dados")
dengue_original=read.csv("denguecases.csv")
library(DT)
# datatable(dengue_original, filter="top", options = list(pageLength = 5, scrollX=T))
# Como é possível observar, a incidência por dengue além de estar por mês e ano, caracterizando uma série temporal, ela está desagregada por regiões também. Se quisermos fazer uma análise com o país como um todo, precisamos agregar os dados das regiões por mês e ano.
denguecases=aggregate(Dengue_Cases~Month+Year,dengue_original,sum)

```


```{r, echo=F, warning=FALSE, results='asis', message = FALSE, out.width = "70%", fig.align = "center"}
datatable(denguecases, filter="top", options = list(pageLength = 5, scrollX=T))

```
\
Colocando em formato de Série temporal utilizando a biblioteca *ts* do R.

---


```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "70%", fig.align = "center"}
#Convertendo os dados para o formato de Séries Temporais
#A frequency=12 foi especificado pois queremos mostrar dos dados mensais
denguecasests=ts(denguecases$Dengue_Cases,start=c(2008,1),end=c(2016,12),frequency=12)
plot(denguecasests, ylab="Casos de Dengue", xlab="Tempo")

```

Fazendo uma análise descritiva da série temporal.

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "70%", fig.align = "center"}
max(denguecasests)
min(denguecasests)
mean(denguecasests)
median(denguecasests)
summary(denguecasests)
length(denguecasests)
start(denguecasests)
end(denguecasests)
frequency(denguecasests)

```

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "70%", fig.align = "center"}
hist(denguecasests)

```

---

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "70%", fig.align = "center"}
boxplot(denguecasests)

```

---

Mudando a janela de tempo da série temporal. Observando apenas os dados de Jan 2010 até Dez de 2012.

```{r, echo=T, warning=FALSE, echo =F, results='asis', message = FALSE, out.width = "70%", fig.align = "center"}

denguecasests2 <- window(denguecasests, start=c(2010,1),end=c(2012,12),frequency=12)
plot(denguecasests2, ylab="Casos de Dengue", xlab="Tempo")

```

---

Uma outra forma de mostrar a śerie temporal na íntegra.

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, fig.align = "center"}
autoplot(denguecasests)

```

---

## Decompondo a Série Temporal

Existem várias técnicas de decomposição de séries temporais. São as principais delas:

- **Clássica:** Geralmente utilizada quando a frequencia da  ST é mensal ou trimestral;

- **X-13ARIMA-SEATS:** Similar a clássica, porém com algumas melhorias;

- **STL (Seasonal and Trend decomposition using Loess):** É mais robusta, é mais sensível a vários tipos de sazonalidade e lida melhor com os *outliers*.

Algumas Referências: 

[Seasonal Adjustment by X-13ARIMA-SEATS in R](https://cran.r-project.org/web/packages/seasonal/vignettes/seas.pdf)

[STL: A seasonal-trend decomposition procedure based on loess](https://www.scb.se/contentassets/ca21efb41fee47d293bbee5bf7be7fb3/stl-a-seasonal-trend-decomposition-procedure-based-on-loess.pdf)


---

**Decomposição Clássica**

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, fig.align = "center"}

library(ggfortify)
# Decomposição da Série Temporal
autoplot(decompose(denguecasests))

```

Em algumas ST não é fácil avaliar suas componentes de maneira visual, ou seja, de maneira gráfica. Para podemos avaliar melhor precisamos utilizar alguns testes estatísticos que possíbilitem tal avaliação. 

---

**Decomposição X-13ARIMA-SEATS**

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, fig.align = "center"}

# Decomposição da Série Temporal
autoplot(seas(denguecasests))

```

---

**Decomposição STL**

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, fig.align = "center"}

autoplot(mstl(denguecasests))

```

---

### Avaliando a Estacionariedade da ST

Segundo o teste de ***Dickey-Fuller***:

$H_{0}$: A ST não é Estacionária

$H_{1}$: A ST é Estacionária

Alguns exemplos:

```{r, echo=F, fig.show = "hold", out.width = "100%", fig.align = "center"}
knitr::include_graphics(c("~/Documentos/cursos_ecologicos_2019/figuras/estacionaria1.png"))
```

---

Fazendo o teste em nossa ST: 

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, fig.align = "center"}
library(tseries)
adf.test(denguecases$Dengue_Cases)

```

Como *p-valor = 0,5442*, não rejeitamos a hipótese nula, ou seja, não há indícios da ST ser estacionária.

### Avaliando a tendência em uma ST

Cosntruindo uma reta baseado no modelo de regressão linear smples para verificar tendência da incidência da dengue.

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "100%", fig.align = "center"}
plot(denguecasests, main = "Incidência de Dengue 20080 and 2016")
abline(reg=lm(denguecasests ~ time(denguecasests)), col = "red")## plotting the trend line of linear regression

```

---

Cosntruindo uma curva suavizada baseada na função *lowess* para verificar tendência da incidência da dengue.

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "100%", fig.align = "center"}
plot(denguecasests, ylab="Casos de Dengue", xlab="Tempo") 
library(Kendall)
lines(lowess(time(denguecasests),denguecasests),lwd=3, col=2)

```


---

Uma outra forma de mostrar a tendência da ST, fazendo a média anual. Observe que a curva se parece um pouco com a curva do *loess* porém menos suave.

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "100%", fig.align = "center"}
plot(aggregate(denguecasests, FUN=mean))

```

---


### Avaliando a Sazonalidade da ST

De maneira visual podemos utilizar algumas técnicas gráficas, tais como:


**Boxplot**

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "100%", fig.align = "center"}
boxplot(denguecasests ~ cycle(denguecasests))  

```


**Monthplot**

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "100%", fig.align = "center"}

# monthplot(denguecasests)  ou
ggsubseriesplot(denguecasests)  

```

---

**Seasonplot**

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "100%", fig.align = "center"}
ggseasonplot(denguecasests)  

```


```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "100%", fig.align = "center"}
ggseasonplot(denguecasests, polar = T)

```


---

Segundo o teste de ***Kruskall-Wallis***:

$H_{0}$: Não existe diferença entre os períodos, ou seja, a série não apresenta sazonalidade

$H_{1}$: Existe diferença em pelo menos um período em relação aos demais, ou seja, há indícios da ST apresentar sazonalidade

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "70%", fig.align = "center"}
kruskal.test(denguecasests ~ cycle(denguecasests))  

```

Neste caso, podemos dizer que existe indícios da da série apresentar períodos que são maiores ou menores que outros.

---

## Transformação 

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "100%", fig.align = "center"}
par(mfrow=c(2,2))

#serie original
plot(denguecasests, ylab="Casos", main="Original")

#lambda = 0, logaritmica 
t1 = BoxCox(denguecasests,lambda =0 )
plot(t1, ylab="Casos", main="Lambda = 0, Logarítmica")

#gera labda automático
lbd = BoxCox.lambda(denguecasests)
# print(lbd)
t3 = BoxCox(denguecasests,lambda =lbd )
plot(t3, ylab="Casos", main="Labda Automático")

#diferenciacao 
t4 = diff(denguecasests)
plot(t4, ylab="Casos", main="Diferenciação")

```

---

## Médias Móveis

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "100%", fig.align = "center"}

par(mfrow=c(2,2))
plot(denguecasests, main="ST original")
#Função do pacote forecast que é utilizado para suavização e limpeza de outliers
dengue3 = tsclean(denguecasests)
plot(dengue3, main="Suavização e Limpeza")
# Média móvel de ordem = 5
dengue1 = ma(denguecasests, order = 5 )
plot(dengue1, main="MA ordem 5")
# Média móvel de ordem = 12
dengue2 = ma(denguecasests,order=12)
plot(dengue2, main="MA ordem 12")


```



```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "100%", fig.align = "center"}
plot(denguecasests, lwd=1.5)
lines(dengue1, lwd=1.5, col="red")
lines(dengue2, lwd=1.5, col="blue")
lines(dengue3, lwd=1.5, col="green")
#legenda
legend("topright",legend=c("Original","MA 5","MA 12","tsclean"), col = c("black","red","blue","green"), lty=1:2, cex=1)

```

---

## Análise dos Resíduos


```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "100%", fig.align = "center"}

prev = auto.arima(denguecasests)
head(prev$residuals)

#analisando os residuais
autoplot(prev$residuals)
hist(prev$residuals)
var(prev$residuals,na.rm = T)
mean(as.vector(prev$residuals),na.rm = T)

```


Segundo o teste de autocorrelação ***Ljung-Box***, temos:

$H_{0}$: Os resíduos são i.i.d.

$H_{1}$: Os resíduos não são i.i.d.


Segundo o teste de normalidade ***Shapiro-Wilk***, temos:

$H_{0}$: Os resíduos apresentam normalidade na distribuição

$H_{1}$: Os resíduos não apresentam normalidade na distribuição

```{r, echo=T, warning=FALSE, results='asis', message = FALSE, out.width = "100%", fig.align = "center"}

#acf 
acf(prev$residuals, na.action = na.pass)
#funcao especial para checar residuais
checkresiduals(prev)
#teste de normalidade
shapiro.test(prev$residuals)

```

- Como o *p-valor = 0.1656* para o tete de Ljung-Box, podemos dizer que não existe evidências de que exista autocorrelação entre as incidências de dengue no período de estudo. 

- Também podemos verificar que o pressuposto de noralidade não pode sr aceito, pois *p-valor = 0.01275 do teste de shapiro-wilk.